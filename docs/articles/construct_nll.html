<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ctsmrTMB">
<title>How to choose your own optimizer • ctsmrTMB</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Mukta-0.4.2/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.2/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to choose your own optimizer">
<meta property="og:description" content="ctsmrTMB">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ctsmrTMB</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/ctsmrTMB.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/construct_nll.html">How to choose your own optimizer</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/phillipbvetter/ctsmrTMB/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to choose your own optimizer</h1>
                        <h4 data-toc-skip class="author"></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/phillipbvetter/ctsmrTMB/blob/HEAD/vignettes/construct_nll.Rmd" class="external-link"><code>vignettes/construct_nll.Rmd</code></a></small>
      <div class="d-none name"><code>construct_nll.Rmd</code></div>
    </div>

    
    
<p>In this document we show how to use the <code>construct_nll</code>
method of a <code>ctsmrTMB</code> class object to construct and extract
the objective function handlers for the objective function, its gradient
and hessian (the latter is only available if the model does not contain
any random effects parameters). These handlers can be parsed to an
optimization algorithm of your own choice, or you can construct your own
objective function which add regularization term on the fixed effects
(although you will lose the automatic derivatives).</p>
<div class="section level2">
<h2 id="simulate-from-the-ornstein-uhlenbeck-process">Simulate from the Ornstein-Uhlenbeck process<a class="anchor" aria-label="anchor" href="#simulate-from-the-ornstein-uhlenbeck-process"></a>
</h2>
<p>We use the common Ornstein-Uhlenbeck process to showcase the use of
<code>construct_nll</code>.</p>
<p><span class="math display">\[ \mathrm{d}X_{t} = \theta (\mu - X_{t})
\, \mathrm{d}t \, + \sigma_{X} \, \mathrm{d}B_{t} \]</span> <span class="math display">\[ Y_{t_{k}} = X_{t_{k}} + e_{t_{k}}, \qquad
e_{t_{k}} \sim \mathcal{N}\left(0,\sigma_{Y}^{2}\right)  \]</span> We
first create data by simulating the process</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate data using Euler Maruyama</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">theta</span><span class="op">=</span><span class="fl">10</span>; <span class="va">mu</span><span class="op">=</span><span class="fl">1</span>; <span class="va">sigma_x</span><span class="op">=</span><span class="fl">1</span>; <span class="va">sigma_y</span><span class="op">=</span><span class="fl">1e-2</span></span>
<span><span class="co"># </span></span>
<span><span class="va">dt.sim</span> <span class="op">=</span> <span class="fl">1e-3</span></span>
<span><span class="va">t.sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,by<span class="op">=</span><span class="va">dt.sim</span><span class="op">)</span></span>
<span><span class="va">dw</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t.sim</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span>,sd<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">dt.sim</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t.sim</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="va">theta</span><span class="op">*</span><span class="op">(</span><span class="va">mu</span><span class="op">-</span><span class="va">x</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">*</span><span class="va">dt.sim</span> <span class="op">+</span> <span class="va">sigma_x</span><span class="op">*</span><span class="va">dw</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Extract observations and add noise</span></span>
<span><span class="va">dt.obs</span> <span class="op">=</span> <span class="fl">1e-2</span></span>
<span><span class="va">t.obs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,by<span class="op">=</span><span class="va">dt.obs</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">t.sim</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">t.obs</span><span class="op">]</span> <span class="op">+</span> <span class="va">sigma_y</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t.obs</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create data</span></span>
<span><span class="va">.data</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  t <span class="op">=</span> <span class="va">t.obs</span>,</span>
<span>  y <span class="op">=</span> <span class="va">y</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="construct-model-object">Construct model object<a class="anchor" aria-label="anchor" href="#construct-model-object"></a>
</h2>
<p>We now construct the <code>ctsmrTMB</code> model object</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create model object</span></span>
<span><span class="va">obj</span> <span class="op">=</span> <span class="va"><a href="../reference/ctsmrTMB.html">ctsmrTMB</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set name of model (and the created .cpp file)</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">set_modelname</span><span class="op">(</span><span class="st">"ornstein_uhlenbeck"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add system equations</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">add_systems</span><span class="op">(</span></span>
<span>  <span class="va">dx</span> <span class="op">~</span> <span class="va">theta</span> <span class="op">*</span> <span class="op">(</span><span class="va">mu</span><span class="op">-</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="va">dt</span> <span class="op">+</span> <span class="va">sigma_x</span><span class="op">*</span><span class="va">dw</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add observation equations</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">add_observations</span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="va">x</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set observation equation variances</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">add_observation_variances</span><span class="op">(</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="va">sigma_y</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify algebraic relations</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">add_algebraics</span><span class="op">(</span></span>
<span>  <span class="va">theta</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logtheta</span><span class="op">)</span>,</span>
<span>  <span class="va">sigma_x</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logsigma_x</span><span class="op">)</span>,</span>
<span>  <span class="va">sigma_y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">logsigma_y</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify parameter initial values and lower/upper bounds in estimation</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">add_parameters</span><span class="op">(</span></span>
<span>  logtheta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>init <span class="op">=</span> <span class="fl">1</span>, lower<span class="op">=</span><span class="fl">1e-5</span>, upper<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>init<span class="op">=</span><span class="fl">1.5</span>, lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">5</span><span class="op">)</span>,</span>
<span>  logsigma_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>init<span class="op">=</span> <span class="fl">1e-1</span>, lower<span class="op">=</span><span class="fl">1e-10</span>, upper<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  logsigma_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>init<span class="op">=</span><span class="fl">1e-1</span>, lower<span class="op">=</span><span class="fl">1e-10</span>, upper<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set initial state mean and covariance</span></span>
<span><span class="va">obj</span><span class="op">$</span><span class="fu">set_initial_state</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">1e-1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="estimation">Estimation<a class="anchor" aria-label="anchor" href="#estimation"></a>
</h2>
<p>We are in principle ready to call the <code>estimate</code> method to
run the optimization scheme using the built-in optimization which uses
<code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb</a></code> i.e.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="fu">estimate</span><span class="op">(</span>data<span class="op">=</span><span class="va">.data</span>, </span>
<span>                   method<span class="op">=</span><span class="st">"ekf"</span>, </span>
<span>                   ode.timestep<span class="op">=</span><span class="va">dt.sim</span>,</span>
<span>                   control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>trace<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Building model...</span></span></code></pre>
<pre><code><span><span class="co">## Loading pre-compiled model...</span></span></code></pre>
<pre><code><span><span class="co">## Checking data...</span></span></code></pre>
<pre><code><span><span class="co">## Constructing objective function...</span></span></code></pre>
<pre><code><span><span class="co">## Minimizing the negative log-likelihood...</span></span></code></pre>
<pre><code><span><span class="co">##   Optimization finished!:</span></span>
<span><span class="co">##             Elapsed time: 0.011 seconds.</span></span>
<span><span class="co">##             The objetive value is: -7.7368e+01</span></span>
<span><span class="co">##             The maximum gradient component is: 1.7e-06</span></span>
<span><span class="co">##             The convergence message is: relative convergence (4)</span></span>
<span><span class="co">##             Iterations: 32</span></span>
<span><span class="co">##             Evaluations: Fun: 53 Grad: 33</span></span>
<span><span class="co">##             See stats::nlminb for available tolerance/control arguments.</span></span></code></pre>
<p>Inside the package we optimise the objective function with respect to
the fixed effects using the construction function handlers from
<code><a href="https://rdrr.io/pkg/TMB/man/MakeADFun.html" class="external-link">TMB::MakeADFun</a></code> and parsing them to
<code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb</a></code> i.e.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># nll = TMB::MakeADFun(...)</span></span>
<span><span class="co"># opt = nlminb(start=nll$par, objective=nll$fn, grad=nll$gr)</span></span></code></pre></div>
<p>The <code>construct_nll</code> method allows you to retrieve the
<code>nll</code> object defined above. You must supply arguments
similarly to when calling <code>estimate</code>. The function handlers
are contained in the <code>nll</code> list object and accessed as
<code>nll$fn()</code>, <code>nll$gr</code> and <code>nll$he()</code> for
the objective function, the gradient, and the hessian respectively. The
initial value for the fixed effects parameters are stored in
<code>nll$par</code>.</p>
<p>The full list of arguments are as follows (see <code><a href="../reference/ctsmrTMB.html">?ctsmrTMB</a></code>
for more information):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nll</span> <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="fu">construct_nll</span><span class="op">(</span>data<span class="op">=</span><span class="va">.data</span>,</span>
<span>                        ode.timestep<span class="op">=</span><span class="va">dt.sim</span>,</span>
<span>                        method<span class="op">=</span><span class="st">"ekf"</span>,</span>
<span>                        compile<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>                        loss<span class="op">=</span><span class="st">"quadratic"</span>,</span>
<span>                        loss_c<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Building model...</span></span></code></pre>
<pre><code><span><span class="co">## Loading pre-compiled model...</span></span></code></pre>
<pre><code><span><span class="co">## Warning: 3 external pointers will be removed</span></span></code></pre>
<pre><code><span><span class="co">## Checking data...</span></span></code></pre>
<pre><code><span><span class="co">## Constructing objective function...</span></span></code></pre>
<pre><code><span><span class="co">## Succesfully returned function handlers</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initial parameters</span></span>
<span><span class="va">nll</span><span class="op">$</span><span class="va">par</span></span></code></pre></div>
<pre><code><span><span class="co">##   logtheta         mu logsigma_x logsigma_y </span></span>
<span><span class="co">##   0.000000   1.500000  -2.302585  -2.302585</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function handler</span></span>
<span><span class="va">nll</span><span class="op">$</span><span class="fu">fn</span><span class="op">(</span><span class="va">nll</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 223.875</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gradient handler</span></span>
<span><span class="va">nll</span><span class="op">$</span><span class="fu">gr</span><span class="op">(</span><span class="va">nll</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          [,1]     [,2]      [,3]      [,4]</span></span>
<span><span class="co">## [1,] 11.53267 83.53293 -234.0808 -363.7823</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Hessian handler</span></span>
<span><span class="va">nll</span><span class="op">$</span><span class="fu">he</span><span class="op">(</span><span class="va">nll</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            [,1]       [,2]       [,3]       [,4]</span></span>
<span><span class="co">## [1,]  22.588626  112.47692  -34.55487   9.805065</span></span>
<span><span class="co">## [2,] 112.476919   79.40811 -136.73914 -27.810820</span></span>
<span><span class="co">## [3,] -34.554871 -136.73914   33.38663 433.525105</span></span>
<span><span class="co">## [4,]   9.805065  -27.81082  433.52511 492.658709</span></span></code></pre>
<p>We can now use these to optimise the function using
e.g. <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim</a></code> instead. You can extract the parameter
bounds specified when calling <code>add_parameters()</code> method by
using the <code>get_parameters</code> method (note that
<code>nll$par</code> and <code>pars$initial</code> are identical).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="fu">get_parameters</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">pars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            type   estimate   initial     lower    upper</span></span>
<span><span class="co">## logtheta   free  2.7106253  0.000000 -11.51293 3.912023</span></span>
<span><span class="co">## mu         free  1.0940506  1.500000   0.00000 5.000000</span></span>
<span><span class="co">## logsigma_x free  0.1310884 -2.302585 -23.02585 2.302585</span></span>
<span><span class="co">## logsigma_y free -3.7464698 -2.302585 -23.02585 2.302585</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opt</span> <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span>par<span class="op">=</span><span class="va">nll</span><span class="op">$</span><span class="va">par</span>, </span>
<span>                   fn<span class="op">=</span><span class="va">nll</span><span class="op">$</span><span class="va">fn</span>, </span>
<span>                   gr<span class="op">=</span><span class="va">nll</span><span class="op">$</span><span class="va">gr</span>, </span>
<span>                   method<span class="op">=</span><span class="st">"L-BFGS-B"</span>, </span>
<span>                   lower<span class="op">=</span><span class="va">pars</span><span class="op">$</span><span class="va">lower</span>, </span>
<span>                   upper<span class="op">=</span><span class="va">pars</span><span class="op">$</span><span class="va">upper</span><span class="op">)</span></span></code></pre></div>
<p>Lets compare the results from using <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim</a></code> with
the extracted function handler versus the internal optimisation that
uses <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb</a></code> stored in <code>fit</code>:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimated parameters</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>external<span class="op">=</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span>, internal<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">par.fixed</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              external   internal</span></span>
<span><span class="co">## logtheta    2.7329513  2.7106253</span></span>
<span><span class="co">## mu          1.0965557  1.0940506</span></span>
<span><span class="co">## logsigma_x  0.1733274  0.1310884</span></span>
<span><span class="co">## logsigma_y -6.7296196 -3.7464698</span></span></code></pre>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Neg. Log-Likelihood</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>external<span class="op">=</span><span class="va">opt</span><span class="op">$</span><span class="va">value</span>, internal<span class="op">=</span><span class="va">fit</span><span class="op">$</span><span class="va">nll</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    external internal</span></span>
<span><span class="co">## 1 -77.28819  -77.368</span></span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Gradient components</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>external<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nll</span><span class="op">$</span><span class="fu">gr</span><span class="op">(</span><span class="va">opt</span><span class="op">$</span><span class="va">par</span><span class="op">)</span><span class="op">)</span>, internal<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">nll</span><span class="op">$</span><span class="fu">gr</span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">par.fixed</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        external      internal</span></span>
<span><span class="co">## 1 -3.803126e-04 -1.673431e-06</span></span>
<span><span class="co">## 2 -4.928238e-04  3.570795e-07</span></span>
<span><span class="co">## 3  8.055609e-05  7.948013e-07</span></span>
<span><span class="co">## 4 -8.146150e-04 -5.908887e-08</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Phillip Vetter.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
